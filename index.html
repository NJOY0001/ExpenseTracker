<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .sidebar { transition: margin-left 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; margin-left: 16rem; /* Default state */ }
        input[type="checkbox"] { transform: scale(1.2); }
        .page-container { display: none; }
        .page-container.active { display: block; }
        .nav-link.active { background-color: #3b82f6; color: white; }
        .sortable:hover { cursor: pointer; background-color: #f3f4f6; }
        .sortable .sort-icon { display: none; }
        .sortable.sort-asc .sort-icon.asc, .sortable.sort-desc .sort-icon.desc { display: inline-block; }
        .original-input { @apply mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Searchable Dropdown */
        .search-container { position: relative; }
        .search-results { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background: white; max-height: 200px; overflow-y: auto; }
        .search-results div { padding: 8px 12px; cursor: pointer; }
        .search-results div:hover { background-color: #f0f2f5; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-white text-gray-800 w-64 space-y-6 py-7 px-2 flex flex-col flex-shrink-0 sidebar fixed top-0 left-0 h-full z-20">
        <div>
            <a href="#" class="text-2xl font-bold px-4 flex items-center space-x-2">
                <i data-lucide="book-marked"></i>
                <span>บันทึกรายจ่าย</span>
            </a>
            <nav class="mt-6">
                <a href="#" data-target="page-expense-form" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg active"><i data-lucide="file-text"></i><span>Expense Form</span></a>
                <a href="#" data-target="page-requisition-form" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg"><i data-lucide="clipboard-list"></i><span>Requisition Form</span></a>
                <a href="#" data-target="page-reports" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg"><i data-lucide="bar-chart-3"></i><span>Reports</span></a>
                <a href="#" data-target="page-inventory" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg"><i data-lucide="boxes"></i><span>Inventory</span></a>
                <a href="#" data-target="page-setting" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg"><i data-lucide="settings"></i><span>Setting</span></a>
            </nav>
        </div>
        <div class="mt-auto p-4">
            <a id="edit-code-link" href="https://script.google.com/home/projects/YOUR_SCRIPT_ID_HERE/edit" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 text-sm text-gray-500 hover:text-blue-600">
                <i data-lucide="code-2"></i>
                <span>Edit App Code</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div id="content" class="flex-1 flex flex-col overflow-hidden main-content">
        <header class="flex justify-between items-center p-4 bg-white border-b sticky top-0 z-10">
            <button id="sidebar-toggle" class="text-gray-600 hover:text-gray-800"><i data-lucide="panel-left-close"></i></button>
            <h1 id="page-title" class="text-xl font-semibold">Expense Form</h1>
            <div class="flex items-center space-x-4"><i data-lucide="bell" class="text-gray-600"></i><img src="https://placehold.co/40x40/E2E8F0/4A5568?text=User" alt="User Avatar" class="rounded-full"></div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-6">
            <!-- Page content will be injected here -->
            <?!= include('page_expense_form'); ?>
            <?!= include('page_requisition_form'); ?>
            <?!= include('page_reports'); ?>
            <?!= include('page_inventory'); ?>
            <?!= include('page_setting'); ?>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center"><div id="modalIcon"></div><h3 id="modalTitle" class="text-xl font-bold mt-4"></h3><p id="modalMessage" class="text-gray-600 mt-2"></p><button id="modalCloseBtn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">ตกลง</button></div></div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3"><h3 id="confirmTitle" class="text-lg font-bold">ยืนยันการกระทำ</h3><p id="confirmMessage" class="text-gray-600 mt-2 py-4"></p><div class="flex justify-end space-x-4 mt-4"><button id="confirmCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ยกเลิก</button><button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ยืนยัน</button></div></div></div>
    
    <div id="supplierModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 lg:w-1/3">
            <h3 class="text-lg font-bold mb-4">Create New Supplier</h3>
            <div class="space-y-4">
                <div><label for="newSupplierName" class="block text-sm font-medium text-gray-700">Supplier Name <span class="text-red-500">*</span></label><input type="text" id="newSupplierName" class="original-input"></div>
                <div><label for="newSupplierInitial" class="block text-sm font-medium text-gray-700">Initial Name <span class="text-red-500">*</span></label><input type="text" id="newSupplierInitial" class="original-input"></div>
                <div><label for="newSupplierAddress" class="block text-sm font-medium text-gray-700">Address</label><textarea id="newSupplierAddress" rows="2" class="original-input"></textarea></div>
                <div><label for="newSupplierTel" class="block text-sm font-medium text-gray-700">Tel.</label><input type="text" id="newSupplierTel" class="original-input"></div>
                <div><label for="newSupplierCreateBy" class="block text-sm font-medium text-gray-700">Create By</label><input type="text" id="newSupplierCreateBy" class="original-input"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="supplierModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ยกเลิก</button>
                <button id="supplierModalSaveBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><span id="supplierSaveBtnText">Save</span><div id="supplierLoader" class="loader hidden ml-2"></div></button>
            </div>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            const { jsPDF } = window.jspdf;
            
            const pageTitle = document.getElementById('page-title');
            let reportDataCache = [];
            let currentSort = { key: 'buyDate', order: 'desc' };
            let inventoryItemMaster = [];
            let supplierList = [];

            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            sidebarToggle.addEventListener('click', () => {
                const isCollapsed = sidebar.style.marginLeft === '-16rem';
                if (isCollapsed) {
                    sidebar.style.marginLeft = '0';
                    content.style.marginLeft = '16rem';
                    sidebarToggle.innerHTML = '<i data-lucide="panel-left-close"></i>';
                } else {
                    sidebar.style.marginLeft = '-16rem';
                    content.style.marginLeft = '0';
                    sidebarToggle.innerHTML = '<i data-lucide="panel-right-close"></i>';
                }
                lucide.createIcons();
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    document.querySelectorAll('.page-container').forEach(p => p.classList.toggle('active', p.id === targetId));
                    document.querySelectorAll('.nav-link').forEach(n => n.classList.toggle('active', n === link));
                    pageTitle.textContent = link.querySelector('span').textContent;
                    if (targetId === 'page-inventory') { inventory.load(); }
                    if (targetId === 'page-requisition-form') { requisitionForm.initialize(); }
                    if (targetId !== 'page-expense-form') { expenseForm.reset(); } else { expenseForm.loadSuppliers(); }
                });
            });
            document.getElementById('goToReqFormBtn2').addEventListener('click', () => {
                document.querySelector('.nav-link[data-target="page-requisition-form"]').click();
            });

            // --- Expense Form Logic ---
            const expenseForm = {
                formTitle: document.getElementById('form-title'),
                editModeRefNoInput: document.getElementById('editModeRefNo'),
                recordDateInput: document.getElementById('recordDate'),
                purchaseDateInput: document.getElementById('purchaseDate'),
                supplierDropdown: document.getElementById('supplierName'),
                itemsTableBody: document.querySelector('#itemsTable tbody'),
                addRowBtn: document.getElementById('addRowBtn'),
                saveBtn: document.getElementById('saveBtn'),
                cancelBtn: document.getElementById('cancelBtn'),
                saveBtnText: document.getElementById('saveBtnText'),
                loader: document.getElementById('loader'),
                rowCount: 0,
                
                initialize() {
                    setInterval(() => this.updateDateTime(), 1000);
                    this.reset();
                    this.addRowBtn.addEventListener('click', () => this.addRow());
                    this.cancelBtn.addEventListener('click', () => this.reset());
                    this.saveBtn.addEventListener('click', () => this.save());
                    this.loadSuppliers();
                    document.getElementById('createNewSupplierBtn').addEventListener('click', () => supplierModal.show());
                },
                loadSuppliers(selectedSupplier = null) {
                    google.script.run.withSuccessHandler(res => {
                        if (res.status === 'success') {
                            supplierList = res.data;
                            this.populateSupplierDropdown(selectedSupplier);
                        }
                    }).getSupplierNames();
                },
                populateSupplierDropdown(selectedValue = null) {
                    this.supplierDropdown.innerHTML = '<option value="">-- เลือก Supplier --</option>';
                    supplierList.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        this.supplierDropdown.appendChild(option);
                    });
                    if (selectedValue) {
                        this.supplierDropdown.value = selectedValue;
                    }
                },
                updateDateTime() { if (!this.editModeRefNoInput.value) this.recordDateInput.value = new Date().toLocaleString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); },
                addRow(item = {}) {
                    this.rowCount++;
                    const row = this.itemsTableBody.insertRow();
                    row.innerHTML = `<td class="px-2 py-2 text-sm text-gray-500">${this.rowCount}</td><td class="px-4 py-2"><input type="text" value="${item.description || ''}" placeholder="รายละเอียด" class="original-input item-desc"></td><td class="px-2 py-2"><input type="number" value="${item.quantity || 1}" min="0" class="original-input calc-input item-qty text-right"></td><td class="px-2 py-2"><input type="text" value="${item.unit || ''}" placeholder="ชิ้น" class="original-input item-unit"></td><td class="px-2 py-2"><input type="number" value="${item.unitPrice || ''}" placeholder="0.00" min="0" step="0.01" class="original-input calc-input item-price text-right"></td><td class="px-2 py-2 text-sm text-right item-total">฿0.00</td><td class="px-2 py-2 text-sm text-right item-vat">฿0.00</td><td class="px-2 py-2 text-center"><input type="checkbox" class="calc-input item-vatable h-5 w-5 text-blue-600" ${item.isVatable !== false ? 'checked' : ''}></td><td class="px-2 py-2 text-center"><button type="button" class="delete-row text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>`;
                    lucide.createIcons();
                    row.querySelector('.delete-row').addEventListener('click', e => { e.currentTarget.closest('tr').remove(); this.updateRowNumbers(); this.updateTotals(); });
                    row.querySelectorAll('.calc-input').forEach(input => input.addEventListener('input', () => this.updateTotals()));
                    this.updateTotals();
                },
                updateRowNumbers() {
                    this.itemsTableBody.querySelectorAll('tr').forEach((row, index) => { row.cells[0].textContent = index + 1; });
                    this.rowCount = this.itemsTableBody.rows.length;
                },
                updateTotals() {
                    let total = 0, vatIncluded = 0, vatExcluded = 0, totalVat = 0, vatableCount = 0;
                    const rows = this.itemsTableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                        const price = parseFloat(row.querySelector('.item-price').value) || 0;
                        const isVatable = row.querySelector('.item-vatable').checked;
                        const itemTotal = qty * price;
                        let itemVat = 0;
                        if (isVatable) { itemVat = itemTotal * 0.07; vatIncluded += itemTotal; totalVat += itemVat; vatableCount++; } else { vatExcluded += itemTotal; }
                        total += itemTotal;
                        row.querySelector('.item-total').textContent = `฿${itemTotal.toFixed(2)}`;
                        row.querySelector('.item-vat').textContent = `฿${itemVat.toFixed(2)}`;
                    });
                    document.getElementById('totalAmount').textContent = `฿${total.toFixed(2)}`;
                    document.getElementById('vatIncludedAmount').textContent = `฿${vatIncluded.toFixed(2)}`;
                    document.getElementById('vatExcludedAmount').textContent = `฿${vatExcluded.toFixed(2)}`;
                    document.getElementById('vatAmount').textContent = `฿${totalVat.toFixed(2)}`;
                    document.getElementById('grandTotal').textContent = `฿${(total + totalVat).toFixed(2)}`;
                    document.getElementById('totalItemCount').textContent = rows.length;
                    document.getElementById('vatableItemCount').textContent = vatableCount;
                    document.getElementById('nonVatableItemCount').textContent = rows.length - vatableCount;
                },
                reset() {
                    this.formTitle.textContent = 'ข้อมูลการจ่ายเงิน';
                    this.saveBtnText.textContent = 'บันทึกข้อมูล';
                    this.editModeRefNoInput.value = '';
                    ['supplierName', 'docNo', 'projectSubject'].forEach(id => document.getElementById(id).value = '');
                    this.purchaseDateInput.valueAsDate = new Date();
                    this.rowCount = 0; this.itemsTableBody.innerHTML = '';
                    google.script.run.withSuccessHandler(refNo => { document.getElementById('internalRefNo').value = refNo; }).generateInternalRefNo();
                    this.addRow();
                },
                loadForEdit(data) {
                    this.reset();
                    this.formTitle.textContent = `แก้ไขบิล: ${data.header.internalRefNo}`;
                    this.saveBtnText.textContent = 'อัปเดตข้อมูล';
                    this.editModeRefNoInput.value = data.header.internalRefNo;
                    
                    document.getElementById('internalRefNo').value = data.header.internalRefNo;
                    document.getElementById('purchaseDate').value = data.header.purchaseDate;
                    this.supplierDropdown.value = data.header.supplierName;
                    document.getElementById('docNo').value = data.header.docNo;
                    document.getElementById('paymentType').value = data.header.paymentType;
                    document.getElementById('projectSubject').value = data.header.projectSubject;
                    
                    this.itemsTableBody.innerHTML = '';
                    this.rowCount = 0;
                    data.items.forEach(item => this.addRow(item));
                    document.querySelector('.nav-link[data-target="page-expense-form"]').click();
                },
                save() {
                    const isUpdate = !!this.editModeRefNoInput.value;
                    const supplierName = this.supplierDropdown.value;
                    const docNo = document.getElementById('docNo').value;
                    
                    if (!supplierName || !docNo) { showNotification('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณาเลือก Supplier และกรอก Document No.'); return; }
                    
                    this.saveBtn.disabled = true; this.saveBtnText.classList.add('hidden'); this.loader.classList.remove('hidden');

                    const proceedWithSave = () => {
                        const headerData = {
                            timestamp: new Date().toISOString(), recordDate: new Date().toLocaleDateString('th-TH'), recordTime: new Date().toLocaleTimeString('th-TH'),
                            purchaseDate: this.purchaseDateInput.value, paymentType: document.getElementById('paymentType').value,
                            projectSubject: document.getElementById('projectSubject').value, supplierName: supplierName,
                            docNo: docNo, internalRefNo: document.getElementById('internalRefNo').value
                        };
                        const items = Array.from(this.itemsTableBody.rows).map(row => ({
                            description: row.querySelector('.item-desc').value, quantity: parseFloat(row.querySelector('.item-qty').value) || 0,
                            unit: row.querySelector('.item-unit').value, unitPrice: parseFloat(row.querySelector('.item-price').value) || 0,
                            isVatable: row.querySelector('.item-vatable').checked
                        })).filter(item => item.description && item.quantity > 0);
                        if (items.length === 0) { showNotification('error', 'ไม่มีรายการ', 'กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ'); this.resetSaveButton(); return; }
                        
                        const serverFunction = isUpdate ? 'updateData' : 'saveData';
                        google.script.run
                            .withSuccessHandler(res => { if (res.status === 'success') { showNotification('success', isUpdate ? 'อัปเดตสำเร็จ!' : 'บันทึกสำเร็จ!', res.message); this.reset(); if(isUpdate) { document.querySelector('.nav-link[data-target="page-reports"]').click(); reports.generate(); } inventory.isLoaded = false; } else { showNotification('error', 'เกิดข้อผิดพลาด!', res.message); } this.resetSaveButton(); })
                            .withFailureHandler(err => { showNotification('error', 'เกิดข้อผิดพลาดรุนแรง!', err.message); this.resetSaveButton(); })
                            [serverFunction]({ header: headerData, items: items });
                    };
                    
                    const currentRefNo = isUpdate ? this.editModeRefNoInput.value : '';
                    google.script.run
                        .withSuccessHandler(isDuplicate => {
                            if (isDuplicate) {
                                showNotification('error', 'บิลซ้ำ', 'มีบิลจาก Supplier นี้ด้วย Document No. นี้อยู่แล้ว');
                                this.resetSaveButton();
                            } else {
                                proceedWithSave();
                            }
                        })
                        .withFailureHandler(err => { showNotification('error', 'ตรวจสอบบิลซ้ำไม่สำเร็จ', err.message); this.resetSaveButton(); })
                        .checkDuplicateBill(supplierName, docNo, currentRefNo);
                },
                resetSaveButton() { this.saveBtn.disabled = false; this.saveBtnText.classList.remove('hidden'); this.loader.classList.add('hidden'); }
            };
            expenseForm.initialize();

            // --- Requisition Form Logic ---
            const requisitionForm = {
                reqNoInput: document.getElementById('reqNo'),
                reqDateInput: document.getElementById('reqDate'),
                requesterInput: document.getElementById('requester'),
                itemsTableBody: document.getElementById('reqItemsTable').querySelector('tbody'),
                addRowBtn: document.getElementById('addReqRowBtn'),
                saveBtn: document.getElementById('saveReqBtn'),
                cancelBtn: document.getElementById('cancelReqBtn'),
                saveBtnText: document.getElementById('saveReqBtnText'),
                loader: document.getElementById('reqLoader'),
                rowCount: 0,

                initialize() {
                    this.reset();
                    this.addRowBtn.addEventListener('click', () => this.addRow());
                    this.cancelBtn.addEventListener('click', () => this.reset());
                    this.saveBtn.addEventListener('click', () => this.save());
                    if (inventoryItemMaster.length === 0) {
                        google.script.run.withSuccessHandler(res => {
                            if (res.status === 'success') inventoryItemMaster = res.data;
                        }).getInventoryItemNames();
                    }
                },
                reset() {
                    this.requesterInput.value = '';
                    this.reqDateInput.valueAsDate = new Date();
                    this.itemsTableBody.innerHTML = '';
                    this.rowCount = 0;
                    google.script.run.withSuccessHandler(reqNo => { this.reqNoInput.value = reqNo; }).generateRequisitionNo();
                    this.addRow();
                },
                addRow() {
                    this.rowCount++;
                    const row = this.itemsTableBody.insertRow();
                    row.innerHTML = `
                        <td class="px-2 py-2 text-sm text-gray-500">${this.rowCount}</td>
                        <td class="px-4 py-2">
                            <div class="search-container">
                                <input type="text" placeholder="-- ค้นหารายการ --" class="original-input item-desc-search">
                                <div class="search-results hidden"></div>
                            </div>
                        </td>
                        <td class="px-2 py-2"><input type="number" value="1" min="1" class="original-input item-qty text-right"></td>
                        <td class="px-2 py-2"><input type="text" placeholder="หน่วย" class="original-input item-unit bg-gray-100" readonly></td>
                        <td class="px-2 py-2 text-center"><button type="button" class="delete-row text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
                    `;
                    lucide.createIcons();
                    this.attachSearchListeners(row);
                    row.querySelector('.delete-row').addEventListener('click', e => e.currentTarget.closest('tr').remove());
                },
                attachSearchListeners(row) {
                    const searchInput = row.querySelector('.item-desc-search');
                    const searchResults = row.querySelector('.search-results');
                    const unitInput = row.querySelector('.item-unit');

                    searchInput.addEventListener('input', () => {
                        const filter = searchInput.value.toLowerCase();
                        searchResults.innerHTML = '';
                        if (filter) {
                            const filteredItems = inventoryItemMaster.filter(item => item.name.toLowerCase().includes(filter));
                            if (filteredItems.length > 0) {
                                searchResults.classList.remove('hidden');
                                filteredItems.forEach(item => {
                                    const div = document.createElement('div');
                                    div.textContent = item.name;
                                    div.dataset.unit = item.unit;
                                    div.addEventListener('click', () => {
                                        searchInput.value = item.name;
                                        unitInput.value = item.unit;
                                        searchResults.classList.add('hidden');
                                    });
                                    searchResults.appendChild(div);
                                });
                            } else {
                                searchResults.classList.add('hidden');
                            }
                        } else {
                            searchResults.classList.add('hidden');
                        }
                    });
                    searchInput.addEventListener('blur', () => {
                        setTimeout(() => searchResults.classList.add('hidden'), 200);
                    });
                },
                save() {
                    this.saveBtn.disabled = true; this.saveBtnText.classList.add('hidden'); this.loader.classList.remove('hidden');
                    const headerData = {
                        reqNo: this.reqNoInput.value,
                        reqDate: this.reqDateInput.value,
                        requester: this.requesterInput.value,
                    };
                    if (!headerData.reqDate || !headerData.requester) { showNotification('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอกวันที่และชื่อผู้เบิก'); this.resetSaveButton(); return; }
                    
                    const items = Array.from(this.itemsTableBody.rows).map(row => ({
                        description: row.querySelector('.item-desc-search').value,
                        quantity: parseFloat(row.querySelector('.item-qty').value) || 0,
                        unit: row.querySelector('.item-unit').value,
                    })).filter(item => item.description && item.quantity > 0);

                    if (items.length === 0) { showNotification('error', 'ไม่มีรายการ', 'กรุณาเพิ่มรายการที่ต้องการเบิก'); this.resetSaveButton(); return; }
                    
                    google.script.run
                        .withSuccessHandler(res => {
                            if(res.status === 'success') { showNotification('success', 'บันทึกสำเร็จ', res.message); this.reset(); inventory.isLoaded = false; }
                            else { showNotification('error', 'ผิดพลาด', res.message); }
                            this.resetSaveButton();
                        })
                        .withFailureHandler(err => { showNotification('error', 'ผิดพลาด', err.message); this.resetSaveButton(); })
                        .saveRequisitionData({header: headerData, items: items});
                },
                resetSaveButton() { this.saveBtn.disabled = false; this.saveBtnText.classList.remove('hidden'); this.loader.classList.add('hidden'); }
            };

            // --- Reports Logic ---
            const reports = {
                startDateInput: document.getElementById('reportStartDate'),
                endDateInput: document.getElementById('reportEndDate'),
                generateBtn: document.getElementById('generateReportBtn'),
                exportPdfBtn: document.getElementById('exportPdfBtn'),
                exportExcelBtn: document.getElementById('exportExcelBtn'),
                loader: document.getElementById('reportLoader'),
                table: document.getElementById('reportTable'),
                tableBody: document.getElementById('reportTableBody'),
                placeholder: document.getElementById('reportPlaceholder'),
                
                initialize() {
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    this.startDateInput.valueAsDate = firstDayOfMonth;
                    this.endDateInput.valueAsDate = today;
                    this.generateBtn.addEventListener('click', () => this.generate());
                    this.exportPdfBtn.addEventListener('click', () => this.exportToPdf());
                    this.exportExcelBtn.addEventListener('click', () => this.exportToExcel());
                    document.querySelectorAll('#reportTable .sortable').forEach(th => th.addEventListener('click', () => this.sort(th.dataset.sort)));
                    this.tableBody.addEventListener('click', e => {
                        const editBtn = e.target.closest('.edit-btn');
                        const deleteBtn = e.target.closest('.delete-btn');
                        if (editBtn) this.handleEdit(editBtn.dataset.internalNo);
                        if (deleteBtn) this.handleDelete(deleteBtn.dataset.internalNo);
                    });
                },
                generate() {
                    const startDate = this.startDateInput.value, endDate = this.endDateInput.value;
                    if (!startDate || !endDate) { showNotification('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด'); return; }
                    this.loader.classList.remove('hidden'); this.table.classList.add('hidden');
                    this.placeholder.textContent = 'กำลังดึงข้อมูล...'; this.placeholder.classList.remove('hidden');
                    [this.exportPdfBtn, this.exportExcelBtn].forEach(b => b.classList.add('hidden'));

                    google.script.run
                        .withSuccessHandler(res => {
                            this.loader.classList.add('hidden');
                            if (res.status === 'success') {
                                reportDataCache = res.data;
                                if (reportDataCache.length > 0) { this.sort(currentSort.key, true); [this.exportPdfBtn, this.exportExcelBtn].forEach(b => b.classList.remove('hidden')); } 
                                else { this.placeholder.textContent = 'ไม่พบข้อมูลในข่วงวันที่ที่เลือก'; this.table.classList.add('hidden'); }
                            } else { showNotification('error', 'เกิดข้อผิดพลาด', res.message); this.placeholder.textContent = 'เกิดข้อผิดพลาดในการดึงข้อมูล'; }
                        })
                        .withFailureHandler(err => { this.loader.classList.add('hidden'); showNotification('error', 'เกิดข้อผิดพลาดรุนแรง', err.message); this.placeholder.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ'; })
                        .getPurchaseReportData(startDate, endDate);
                },
                render(data) {
                    this.tableBody.innerHTML = '';
                    if (data.length === 0) { this.placeholder.textContent = 'ไม่พบข้อมูลในข่วงวันที่ที่เลือก'; this.placeholder.classList.remove('hidden'); this.table.classList.add('hidden'); return; }
                    this.placeholder.classList.add('hidden'); this.table.classList.remove('hidden');
                    let totalAmount = 0, totalVat = 0, grandTotal = 0;
                    data.forEach(item => {
                        const row = this.tableBody.insertRow();
                        row.innerHTML = `<td class="px-4 py-2 text-sm">${item.buyDate}</td><td class="px-4 py-2 text-sm">${item.payBy}</td><td class="px-4 py-2 text-sm">${item.internalNo}</td><td class="px-4 py-2 text-sm">${item.supplierName}</td><td class="px-4 py-2 text-sm">${item.docNo}</td><td class="px-4 py-2 text-sm text-right">${item.itemCount}</td><td class="px-4 py-2 text-sm text-right">${item.amount.toFixed(2)}</td><td class="px-4 py-2 text-sm text-right">${item.vat.toFixed(2)}</td><td class="px-4 py-2 text-sm text-right font-medium">${item.totalAmount.toFixed(2)}</td><td class="px-4 py-2 text-center text-sm"><button class="edit-btn text-blue-600 hover:text-blue-800 p-1" data-internal-no="${item.internalNo}"><i data-lucide="edit"></i></button><button class="delete-btn text-red-600 hover:text-red-800 p-1" data-internal-no="${item.internalNo}"><i data-lucide="trash-2"></i></button></td>`;
                        totalAmount += item.amount; totalVat += item.vat; grandTotal += item.totalAmount;
                    });
                    lucide.createIcons();
                    document.getElementById('reportTotalAmount').textContent = totalAmount.toFixed(2);
                    document.getElementById('reportTotalVat').textContent = totalVat.toFixed(2);
                    document.getElementById('reportGrandTotal').textContent = grandTotal.toFixed(2);
                },
                sort(key, keepOrder = false) {
                    if (!keepOrder) { currentSort.order = (currentSort.key === key && currentSort.order === 'asc') ? 'desc' : 'asc'; }
                    currentSort.key = key;
                    reportDataCache.sort((a, b) => {
                        const valA = a[key], valB = b[key], order = currentSort.order === 'asc' ? 1 : -1;
                        if (typeof valA === 'string') return valA.localeCompare(valB) * order;
                        return (valA - valB) * order;
                    });
                    document.querySelectorAll('#reportTable .sortable').forEach(th => {
                        th.classList.remove('sort-asc', 'sort-desc');
                        if (th.dataset.sort === key) th.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                    });
                    this.render(reportDataCache);
                },
                handleEdit(internalNo) {
                    showNotification('info', 'กำลังโหลดข้อมูล...', `กำลังโหลดข้อมูลสำหรับบิล ${internalNo}`);
                    google.script.run
                        .withSuccessHandler(res => {
                            if (res.status === 'success') { expenseForm.loadForEdit(res.data); } 
                            else { showNotification('error', 'ผิดพลาด', res.message); }
                        })
                        .withFailureHandler(err => showNotification('error', 'ผิดพลาด', err.message))
                        .getBillDetails(internalNo);
                },
                handleDelete(internalNo) {
                    showConfirm('ยืนยันการลบ', `คุณต้องการลบบิล ${internalNo} และรายการทั้งหมดในบิลนี้ใช่หรือไม่?`, () => {
                        showNotification('info', 'กำลังลบ...', `กำลังลบบิล ${internalNo}`);
                        google.script.run
                            .withSuccessHandler(res => {
                                if (res.status === 'success') { showNotification('success', 'ลบสำเร็จ', res.message); this.generate(); } 
                                else { showNotification('error', 'ผิดพลาด', res.message); }
                            })
                            .withFailureHandler(err => showNotification('error', 'ผิดพลาด', err.message))
                            .deleteBill(internalNo);
                    });
                },
                exportToPdf() {
                    const doc = new jsPDF();
                    doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/Sarabun/0.1.0/Sarabun-Regular.ttf', 'Sarabun', 'normal');
                    doc.setFont('Sarabun');
                    
                    const startDate = new Date(this.startDateInput.value).toLocaleDateString('th-TH');
                    const endDate = new Date(this.endDateInput.value).toLocaleDateString('th-TH');
                    doc.text(`รายงานการซื้อ (By Bill) วันที่ ${startDate} - ${endDate}`, 14, 15);
                    
                    const head = [['Buy Date', 'Pay by', 'Internal No.', 'Supplier', 'Doc.No', '#', 'Amount', 'Vat7%', 'Total']];
                    const body = reportDataCache.map(item => [item.buyDate, item.payBy, item.internalNo, item.supplierName, item.docNo, item.itemCount, item.amount.toFixed(2), item.vat.toFixed(2), item.totalAmount.toFixed(2)]);
                    
                    doc.autoTable({
                        head: head,
                        body: body,
                        startY: 20,
                        styles: { font: 'Sarabun', fontStyle: 'normal' },
                        headStyles: { fontStyle: 'bold' }
                    });
                    doc.save('report.pdf');
                },
                exportToExcel() {
                    const headers = {
                        buyDate: 'Buy Date', payBy: 'Pay by', internalNo: 'Internal No.', 
                        supplierName: 'Supplier Name', docNo: 'Doc.No', itemCount: '# Items', 
                        amount: 'Amount', vat: 'Vat7%', totalAmount: 'Total Amount'
                    };
                    const dataToExport = reportDataCache.map(item => ({
                        [headers.buyDate]: item.buyDate,
                        [headers.payBy]: item.payBy,
                        [headers.internalNo]: item.internalNo,
                        [headers.supplierName]: item.supplierName,
                        [headers.docNo]: item.docNo,
                        [headers.itemCount]: item.itemCount,
                        [headers.amount]: item.amount,
                        [headers.vat]: item.vat,
                        [headers.totalAmount]: item.totalAmount
                    }));

                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Report");
                    XLSX.writeFile(wb, "PurchaseReport.xlsx");
                }
            };
            reports.initialize();
            
            // --- Inventory Logic ---
            const inventory = {
                summaryContainer: document.getElementById('inventory-summary'),
                tableBody: document.getElementById('inventory-table-body'),
                loader: document.getElementById('inventory-loader'),
                placeholder: document.getElementById('inventory-placeholder'),
                isLoaded: false,

                load() {
                    if (this.isLoaded) return;
                    this.loader.classList.remove('hidden');
                    this.placeholder.classList.add('hidden');

                    google.script.run
                        .withSuccessHandler(res => {
                            this.loader.classList.add('hidden');
                            if (res.status === 'success') {
                                this.render(res.data);
                                this.isLoaded = true;
                            } else {
                                this.placeholder.textContent = `เกิดข้อผิดพลาด: ${res.message}`;
                                this.placeholder.classList.remove('hidden');
                            }
                        })
                        .withFailureHandler(err => {
                             this.loader.classList.add('hidden');
                             this.placeholder.textContent = `เกิดข้อผิดพลาดในการเชื่อมต่อ: ${err.message}`;
                             this.placeholder.classList.remove('hidden');
                        })
                        .getInventoryData();
                },
                render(data) {
                    this.placeholder.classList.add('hidden');
                    this.summaryContainer.innerHTML = `
                        <div class="bg-blue-100 p-4 rounded-lg flex items-center"><i data-lucide="package" class="w-10 h-10 text-blue-500 mr-4"></i><div><div class="text-2xl font-bold">${data.summary.totalItems}</div><div class="text-gray-600">รายการสินค้า</div></div></div>
                        <div class="bg-green-100 p-4 rounded-lg flex items-center"><i data-lucide="dollar-sign" class="w-10 h-10 text-green-500 mr-4"></i><div><div class="text-2xl font-bold">฿${data.summary.totalStockValue.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div><div class="text-gray-600">มูลค่า Stock</div></div></div>
                        <div class="bg-yellow-100 p-4 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="w-10 h-10 text-yellow-500 mr-4"></i><div><div class="text-2xl font-bold">${data.summary.lowStockCount}</div><div class="text-gray-600">ใกล้หมด</div></div></div>
                        <div class="bg-red-100 p-4 rounded-lg flex items-center"><i data-lucide="package-x" class="w-10 h-10 text-red-500 mr-4"></i><div><div class="text-2xl font-bold">${data.summary.outOfStockCount}</div><div class="text-gray-600">หมดแล้ว</div></div></div>
                    `;
                    this.tableBody.innerHTML = '';
                    data.items.forEach((item, index) => {
                        const row = this.tableBody.insertRow();
                        row.innerHTML = `
                            <td class="px-6 py-4 text-sm">${index + 1}</td>
                            <td class="px-6 py-4 text-sm">
                                <div class="font-bold">${item.name}</div>
                                <div class="text-xs text-gray-500">รหัส: ${item.code} | หน่วย: ${item.unit}</div>
                                <div class="text-xs text-green-600">฿${item.avgPrice.toFixed(2)}/หน่วย</div>
                            </td>
                            <td class="px-6 py-4 text-sm font-bold text-lg">${item.quantity.toLocaleString('th-TH')} <span class="text-xs font-normal text-gray-500">${item.unit}</span></td>
                            <td class="px-6 py-4 text-sm">฿${item.stockValue.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="px-6 py-4 text-sm">${item.safetyStock.toLocaleString('th-TH')}</td>
                            <td class="px-6 py-4 text-sm"><span class="px-3 py-1 rounded-full text-xs font-medium text-white bg-${item.statusColor}-500">${item.status}</span></td>
                        `;
                    });
                    lucide.createIcons();
                }
            };
            
            // --- Supplier Modal Logic ---
            const supplierModal = {
                modal: document.getElementById('supplierModal'),
                saveBtn: document.getElementById('supplierModalSaveBtn'),
                cancelBtn: document.getElementById('supplierModalCancelBtn'),
                saveBtnText: document.getElementById('supplierSaveBtnText'),
                loader: document.getElementById('supplierLoader'),
                nameInput: document.getElementById('newSupplierName'),
                initialInput: document.getElementById('newSupplierInitial'),
                addressInput: document.getElementById('newSupplierAddress'),
                telInput: document.getElementById('newSupplierTel'),
                createByInput: document.getElementById('newSupplierCreateBy'),
                
                initialize() {
                    this.cancelBtn.addEventListener('click', () => this.hide());
                    this.saveBtn.addEventListener('click', () => this.save());
                },
                show() { this.modal.classList.remove('hidden'); },
                hide() { this.modal.classList.add('hidden'); this.reset(); },
                reset() {
                    this.nameInput.value = '';
                    this.initialInput.value = '';
                    this.addressInput.value = '';
                    this.telInput.value = '';
                    this.createByInput.value = '';
                },
                save() {
                    const supplierData = {
                        name: this.nameInput.value.trim(),
                        initial: this.initialInput.value.trim(),
                        address: this.addressInput.value.trim(),
                        tel: this.telInput.value.trim(),
                        createdBy: this.createByInput.value.trim()
                    };
                    if (!supplierData.name || !supplierData.initial) {
                        showNotification('error', 'ข้อมูลไม่ครบถ้วน', 'กรุณากรอก Supplier Name และ Initial Name');
                        return;
                    }
                    this.saveBtn.disabled = true; this.saveBtnText.classList.add('hidden'); this.loader.classList.remove('hidden');
                    google.script.run
                        .withSuccessHandler(res => {
                            if (res.status === 'success') {
                                showNotification('success', 'สำเร็จ', res.message);
                                expenseForm.loadSuppliers(res.newSupplier.name);
                                this.hide();
                            } else {
                                showNotification('error', 'ผิดพลาด', res.message);
                            }
                            this.resetSaveButton();
                        })
                        .withFailureHandler(err => {
                            showNotification('error', 'ผิดพลาดรุนแรง', err.message);
                            this.resetSaveButton();
                        })
                        .saveNewSupplier(supplierData);
                },
                resetSaveButton() {
                    this.saveBtn.disabled = false;
                    this.saveBtnText.classList.remove('hidden');
                    this.loader.classList.add('hidden');
                }
            };
            supplierModal.initialize();

            // --- Settings Logic ---
            const settings = {
                recalculateBtn: document.getElementById('recalculateInventoryBtn'),
                initialize() {
                    if(this.recalculateBtn) {
                        this.recalculateBtn.addEventListener('click', this.handleRecalculate);
                    }
                },
                handleRecalculate() {
                    showConfirm('ยืนยันการคำนวณใหม่', 'การกระทำนี้จะลบข้อมูลสต็อกปัจจุบันทั้งหมด และสร้างใหม่จากข้อมูลการซื้อทั้งหมดในระบบ ต้องการดำเนินการต่อหรือไม่?', () => {
                        showNotification('info', 'กำลังคำนวณ...', 'ระบบกำลังประมวลผลข้อมูลสต็อกใหม่ทั้งหมด');
                        google.script.run
                            .withSuccessHandler(res => {
                                if (res.status === 'success') {
                                    showNotification('success', 'สำเร็จ', res.message);
                                    inventory.isLoaded = false; // Force reload on next visit
                                } else {
                                    showNotification('error', 'ผิดพลาด', res.message);
                                }
                            })
                            .withFailureHandler(err => {
                                showNotification('error', 'ผิดพลาดรุนแรง', err.message);
                            })
                            .recalculateInventory();
                    });
                }
            };
            settings.initialize();


            // --- Modals ---
            const notificationModal = { element: document.getElementById('notificationModal'), icon: document.getElementById('modalIcon'), title: document.getElementById('modalTitle'), message: document.getElementById('modalMessage'), closeBtn: document.getElementById('modalCloseBtn') };
            notificationModal.closeBtn.addEventListener('click', () => notificationModal.element.classList.add('hidden'));
            function showNotification(type, title, message) {
                notificationModal.title.textContent = title; notificationModal.message.textContent = message;
                notificationModal.icon.innerHTML = (type === 'success') ? `<i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto"></i>` : (type === 'info') ? `<i data-lucide="info" class="w-16 h-16 text-blue-500 mx-auto"></i>` : `<i data-lucide="x-circle" class="w-16 h-16 text-red-500 mx-auto"></i>`;
                lucide.createIcons(); notificationModal.element.classList.remove('hidden');
            }
            const confirmModal = { element: document.getElementById('confirmModal'), title: document.getElementById('confirmTitle'), message: document.getElementById('confirmMessage'), cancelBtn: document.getElementById('confirmCancelBtn'), okBtn: document.getElementById('confirmOkBtn') };
            let confirmCallback = () => {};
            confirmModal.cancelBtn.addEventListener('click', () => confirmModal.element.classList.add('hidden'));
            confirmModal.okBtn.addEventListener('click', () => { confirmModal.element.classList.add('hidden'); confirmCallback(); });
            function showConfirm(title, message, onConfirm) {
                confirmModal.title.textContent = title; confirmModal.message.textContent = message;
                confirmCallback = onConfirm; confirmModal.element.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
